@{
    ViewData["Title"] = "Tổng quan";
}

<div class="row g-4">
    <div class="col-12">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
            <div>
                <h2 class="fw-bold mb-1">📊 Tổng quan</h2>
                <p class="text-muted mb-0">Thống kê tình hình cửa hàng nông sản sạch.</p>
            </div>
            <div>
                <span class="badge rounded-pill bg-success text-white px-3 py-2">
                    <i class="bi bi-check-circle me-1"></i> Hệ thống hoạt động tốt
                </span>
            </div>
        </div>
    </div>

    <!-- Báo cáo nhanh -->
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri text-center">
            <div class="card-body">
                <i class="bi bi-basket fs-2 text-primary"></i>
                <h5 class="mt-2">Sản phẩm</h5>
                <h3 class="fw-bold">@ViewBag.TotalProducts</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri text-center">
            <div class="card-body">
                <i class="bi bi-grid fs-2 text-success"></i>
                <h5 class="mt-2">Danh mục</h5>
                <h3 class="fw-bold">@ViewBag.TotalCategories</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri text-center">
            <div class="card-body">
                <i class="bi bi-receipt fs-2 text-danger"></i>
                <h5 class="mt-2">Đơn hàng</h5>
                <h3 class="fw-bold">@ViewBag.TotalOrders</h3>
            </div>
        </div>
    </div>

    <!-- Thương hiệu (thay Doanh thu) -->
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri text-center">
            <div class="card-body">
                <i class="bi bi-flag fs-2 text-warning"></i>
                <h5 class="mt-2">Thương hiệu</h5>
                <h3 class="fw-bold">@ViewBag.TotalBrands</h3>
            </div>
        </div>
    </div>
</div>

<!-- Bộ lọc khoảng ngày cho biểu đồ -->
<div class="card border-0 shadow-sm rounded-4 mb-3 mt-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end needs-validation" novalidate>
            <div class="col-sm-4 col-md-3">
                <label class="form-label">Từ ngày</label>
               <input type="text"
       class="form-control flatpickr"
       name="from"
       value="@ViewBag.FilterFrom"
       placeholder="dd/MM/yyyy"
       required />
                <div class="invalid-feedback">Chọn ngày bắt đầu.</div>
            </div>
            <div class="col-sm-4 col-md-3">
                <label class="form-label">Đến ngày</label>
        <input type="text"
       class="form-control flatpickr"
       name="to"
       value="@ViewBag.FilterTo"
       placeholder="dd/MM/yyyy"
       required />
                <div class="invalid-feedback">Chọn ngày kết thúc.</div>
            </div>
            <div class="col-sm-4 col-md-3 d-flex gap-2">
                <button class="btn btn-green align-self-end px-4">
                    <i class="bi bi-funnel"></i> Lọc
                </button>
                <a class="btn btn-outline-primary align-self-end"
   asp-area="Admin"
   asp-controller="Home"
   asp-action="ExportReport"
   asp-route-from="@ViewBag.FilterFrom"
   asp-route-to="@ViewBag.FilterTo">
    <i class="bi bi-file-earmark-excel"></i> Xuất báo cáo
</a>

                <a class="btn btn-outline-green align-self-end" asp-area="Admin" asp-controller="Home" asp-action="Index">
                    Reset
                </a>
            </div>
            <div class="col-12 col-md-3">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-green w-100 preset" data-preset="7">7 ngày</button>
                    <button type="button" class="btn btn-green w-100 preset" data-preset="30">30 ngày</button>
                    <button type="button" class="btn btn-green w-100 preset" data-preset="month">Tháng này</button>
                </div>
            </div>
        </form>
        <div class="small text-muted mt-2">
            Khoảng đang xem: <b>@ViewBag.FilterFromText</b> → <b>@ViewBag.FilterToText</b>
            &nbsp;•&nbsp; Tổng đơn: <span class="fw-semibold">@ViewBag.RangeTotalOrders</span>
            &nbsp;•&nbsp; Doanh thu: <span class="text-danger fw-semibold">@String.Format("{0:N0} ₫", ViewBag.RangeTotalRevenue)</span>
        </div>
    </div>
</div>

<!-- Biểu đồ -->
<div class="card border-0 shadow-sm rounded-4">
    <div class="card-body">
        <h5 class="fw-bold mb-3">📈 Doanh thu & Đơn hàng theo ngày</h5>
        <canvas id="revenueChart" height="100"></canvas>
    </div>
</div>

<!-- Các mục quản lý -->
<div class="row g-4 mt-4">
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-circle bg-success-subtle text-success me-2">
                        <i class="bi bi-grid"></i>
                    </div>
                    <h5 class="mb-0">Danh mục</h5>
                </div>
                <p class="text-muted small flex-grow-1">Quản lý nhóm sản phẩm và phân loại dễ dàng.</p>
                <a class="btn btn-sm btn-success mt-auto" asp-area="Admin" asp-controller="DanhMucs" asp-action="Index">Vào trang</a>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-circle bg-warning-subtle text-warning me-2">
                        <i class="bi bi-flag"></i>
                    </div>
                    <h5 class="mb-0">Thương hiệu</h5>
                </div>
                <p class="text-muted small flex-grow-1">Theo dõi và quản lý các thương hiệu uy tín.</p>
                <a class="btn btn-sm btn-warning mt-auto text-white" asp-area="Admin" asp-controller="ThuongHieus" asp-action="Index">Vào trang</a>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-circle bg-primary-subtle text-primary me-2">
                        <i class="bi bi-basket"></i>
                    </div>
                    <h5 class="mb-0">Sản phẩm</h5>
                </div>
                <p class="text-muted small flex-grow-1">Quản lý danh sách sản phẩm & tồn kho.</p>
                <a class="btn btn-sm btn-primary mt-auto" asp-area="Admin" asp-controller="SanPhams" asp-action="Index">Vào trang</a>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="card h-100 border-0 shadow-sm agri">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-circle bg-danger-subtle text-danger me-2">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <h5 class="mb-0">Đơn hàng</h5>
                </div>
                <p class="text-muted small flex-grow-1">Theo dõi tình trạng và xử lý đơn hàng.</p>
                <a class="btn btn-sm btn-danger mt-auto" asp-area="Admin" asp-controller="DonHangs" asp-action="Index">Vào trang</a>
            </div>
        </div>
    </div>
</div>

<style>
    .icon-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1.2rem;
    }

    .card.agri:hover {
        transform: translateY(-3px);
        transition: all .2s ease-in-out;
        box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }

    .rounded-4 {
        border-radius: 1rem;
    }

    /* Nút xanh chữ trắng */
    .btn-green {
        background: #198754;
        color: #fff !important;
        border: none;
        border-radius: .5rem;
        font-weight: 600;
        transition: .2s ease-in-out;
    }

        .btn-green:hover {
            filter: brightness(.95);
            transform: translateY(-1px);
        }

    /* Nút viền xanh */
    .btn-outline-green {
        color: #198754 !important;
        border: 2px solid #198754 !important;
        border-radius: .5rem;
        font-weight: 600;
    }

        .btn-outline-green:hover {
            background: #198754 !important;
            color: #fff !important;
        }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.RevenueLabels)),
                datasets: [
                    {
                        label: 'Doanh thu (₫)',
                        data: @Html.Raw(Json.Serialize(ViewBag.RevenueValues)),
                        borderWidth: 1,
                        backgroundColor: 'rgba(0, 200, 83, 0.6)',
                        borderColor: 'rgba(0, 200, 83, 1)',
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Số đơn hàng',
                        data: @Html.Raw(Json.Serialize(ViewBag.OrderValues)),
                        borderWidth: 1,
                        backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        borderColor: '#007bff',
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y1: {
                        type: 'linear', display: true, position: 'left', beginAtZero: true,
                        ticks: { callback: v => Number(v).toLocaleString('vi-VN') + ' ₫' }
                    },
                    y2: { type: 'linear', display: true, position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } }
                }
            }
        });

        // Preset nhanh
        (function () {
            const form = document.querySelector('form.needs-validation');
            const from = form.querySelector('input[name="from"]');
            const to   = form.querySelector('input[name="to"]');
            const presets = document.querySelectorAll('.preset');

            function iso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` }

            presets.forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.preset;
                    const today = new Date();
                    let fromDate = new Date(today);

                    if (type === '7') fromDate.setDate(today.getDate() - 6);
                    else if (type === '30') fromDate.setDate(today.getDate() - 29);
                    else if (type === 'month') fromDate = new Date(today.getFullYear(), today.getMonth(), 1);

                    from.value = iso(fromDate);
                    to.value   = iso(today);
                    form.submit();
                });
            });

            form.addEventListener('submit', function(e){
                if(!form.checkValidity()){ e.preventDefault(); e.stopPropagation(); }
                form.classList.add('was-validated');
            }, false);
        })();
    </script>
    <script>
    flatpickr(".flatpickr", {
        locale: "vn",
        dateFormat: "Y-m-d",      // 👈 format gửi về server
        altInput: true,
        altFormat: "d/m/Y",       // 👈 format hiển thị cho người dùng
        allowInput: true
    });
</script>

}
