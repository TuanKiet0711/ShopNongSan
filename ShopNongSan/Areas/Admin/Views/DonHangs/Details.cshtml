@model ShopNongSan.Models.DonHang
@{
    ViewData["Title"] = "Chi tiết đơn " + Model.MaDonHang;

    string BadgeClass(string s) => s switch
    {
        "Chờ xử lý" => "status-badge bg-warning text-white",
        "Đã xác nhận" => "status-badge bg-info text-white",
        "Đang giao" => "status-badge bg-primary text-white",
        "Hoàn tất" => "status-badge bg-success text-white",
        "Đã hủy" => "status-badge bg-danger text-white",
        _ => "status-badge bg-secondary text-white"
    };

    string PaymentText(string? v) => v switch
    {
        "VNPAY" => "VNPAY (Thanh toán trực tuyến)",
        "BANK" => "Chuyển khoản ngân hàng",
        "COD" => "Thanh toán khi nhận (COD)",
        _ => "-"
    };
}

<div class="d-flex align-items-center mb-3 gap-2">
    <h2 class="mb-0 fw-bold text-success">
        <i class="bi bi-receipt"></i> Đơn: @Model.MaDonHang
    </h2>
    <span class="@BadgeClass(Model.TrangThai)">@Model.TrangThai</span>
</div>

<div class="row g-3">
    <!-- THÔNG TIN CHUNG -->
    <div class="col-lg-4">
        <div class="card shadow-sm rounded-4">
            <div class="card-body">
                <h5 class="card-title fw-semibold text-success">
                    <i class="bi bi-person-vcard me-1"></i> Thông tin chung
                </h5>
                <dl class="row mb-0">
                    <dt class="col-5">Mã đơn</dt>
                    <dd class="col-7">@Model.MaDonHang</dd>

                    <dt class="col-5">Người nhận</dt>
                    <dd class="col-7">@(!string.IsNullOrWhiteSpace(Model.HoTen) ? Model.HoTen : (Model.TaiKhoan?.HoTen ?? "-"))</dd>

                    <dt class="col-5">Số điện thoại</dt>
                    <dd class="col-7">@(!string.IsNullOrWhiteSpace(Model.SoDienThoai) ? Model.SoDienThoai : (Model.TaiKhoan?.ThongTinNguoiDung?.SoDienThoai ?? "-"))</dd>

                    <dt class="col-5">Địa chỉ</dt>
                    <dd class="col-7">@(!string.IsNullOrWhiteSpace(Model.DiaChi) ? Model.DiaChi : (Model.TaiKhoan?.ThongTinNguoiDung?.DiaChi ?? "-"))</dd>

                    <dt class="col-5">Ghi chú</dt>
                    <dd class="col-7">@(!string.IsNullOrWhiteSpace(Model.GhiChu) ? Model.GhiChu : "-")</dd>

                    <dt class="col-5">Phương thức thanh toán</dt>
                    <dd class="col-7">
                        <span class="badge bg-dark-subtle text-dark fw-semibold px-3 py-2">
                            @PaymentText(Model.PhuongThucThanhToan)
                        </span>
                    </dd>

                    <dt class="col-5">Trạng thái</dt>
                    <dd class="col-7">
                        <span class="@BadgeClass(Model.TrangThai)">@Model.TrangThai</span>
                    </dd>

                    <dt class="col-5">Tổng tiền</dt>
                    <dd class="col-7 fw-semibold text-danger">@Model.TongTien.ToString("N0") đ</dd>

                    <dt class="col-5">Ngày đặt</dt>
                    <dd class="col-7">@Model.NgayDat?.ToString("dd/MM/yyyy HH:mm")</dd>

                    <dt class="col-5">Ngày giao dự kiến</dt>
                    <dd class="col-7">@Model.NgayGiao?.ToString("dd/MM/yyyy")</dd>
                </dl>

                <!-- HỦY ĐƠN -->
                @if (string.Equals(Model.TrangThai, "Chờ xử lý", StringComparison.OrdinalIgnoreCase))
                {
                    <form asp-action="Cancel" method="post" class="mt-3"
                          onsubmit="return confirm('Bạn chắc muốn hủy đơn này?')">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-x-octagon"></i> Hủy đơn
                        </button>
                    </form>
                }
            </div>
        </div>
    </div>

    <!-- SẢN PHẨM -->
    <div class="col-lg-8">
        <div class="card shadow-sm rounded-4">
            <div class="card-body">
                <h5 class="card-title fw-semibold text-success">
                    <i class="bi bi-bag-check me-1"></i> Sản phẩm trong đơn
                </h5>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center mb-0">
                        <thead class="table-success">
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Đơn giá</th>
                                <th>SL</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ct in Model.DonHangChiTiets)
                            {
                                <tr>
                                    <td>@ct.SanPham?.Ten</td>
                                    <td>@ct.DonGia.ToString("N0") đ</td>
                                    <td>@ct.SoLuong</td>
                                    <td>@((ct.DonGia * ct.SoLuong).ToString("N0")) đ</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Tổng cộng</th>
                                <th class="text-end text-danger fw-bold">@Model.TongTien.ToString("N0") đ</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NÚT QUAY LẠI -->
<div class="mt-3 d-flex justify-content-end gap-2">
    <a asp-action="Index" class="btn btn-secondary text-white">
        <i class="bi bi-arrow-left me-1"></i> Quay lại danh sách
    </a>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
        .table thead.table-success th {
            background: #198754 !important;
            color: #fff !important;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: .875rem;
            font-weight: 700;
            color: #fff !important;
        }

        .bg-warning.text-white {
            background-color: #ffc107 !important;
        }

        .bg-primary.text-white {
            background-color: #0d6efd !important;
        }

        .bg-info.text-white {
            background-color: #0dcaf0 !important;
        }

        .bg-success.text-white {
            background-color: #198754 !important;
        }

        .bg-danger.text-white {
            background-color: #dc3545 !important;
        }

        .rounded-4 {
            border-radius: 1rem;
        }

        .btn-secondary.text-white {
            color: #fff !important;
        }
    </style>
}
