@model ShopNongSan.Models.DonHang
@{
    ViewData["Title"] = "Sửa đơn " + Model.MaDonHang;

    // Badge đồng bộ với Index (chữ trắng)
    string BadgeClass(string s) => s switch
    {
        "Chờ xử lý" => "status-badge bg-warning text-white",
        "Đã xác nhận" => "status-badge bg-info text-white",
        "Đang giao" => "status-badge bg-primary text-white",
        "Hoàn tất" => "status-badge bg-success text-white",
        "Đã hủy" => "status-badge bg-danger text-white",
        _ => "status-badge bg-secondary text-white"
    };

    string PtttText(string? v)
        => v == "BANK" ? "Chuyển khoản"
         : v == "COD" ? "Thanh toán khi nhận (COD)"
         : "-";

    string FormatDateTime(DateTime? dt)
        => dt.HasValue ? dt.Value.ToString("dd/MM/yyyy HH:mm") : "-";
    string FormatDate(DateTime? d)
        => d.HasValue ? d.Value.ToString("dd/MM/yyyy") : "-";
}

<div class="d-flex align-items-center mb-3 gap-2">
    <h2 class="mb-0 fw-bold text-success">
        <i class="bi bi-receipt"></i> Sửa đơn: @Model.MaDonHang
    </h2>
    <span class="@BadgeClass(Model.TrangThai)">@Model.TrangThai</span>
</div>

<form asp-action="Edit" method="post" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.Id" />

    <div class="row g-3">
        <!-- CỘT TRÁI: THÔNG TIN ĐƠN (READ-ONLY) -->
        <div class="col-lg-6">
            <div class="card shadow-sm rounded-4 mb-3">
                <div class="card-body">
                    <h5 class="card-title section-title"><i class="bi bi-receipt me-2"></i>Thông tin đơn</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Mã đơn</label>
                            <input class="form-control ns-readonly" value="@Model.MaDonHang" disabled />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Trạng thái hiện tại</label>
                            <input class="form-control ns-readonly" value="@Model.TrangThai" disabled />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ngày đặt</label>
                            <input class="form-control ns-readonly" value="@FormatDateTime(Model.NgayDat)" disabled />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ngày giao dự kiến</label>
                            <input class="form-control ns-readonly" value="@FormatDate(Model.NgayGiao)" disabled />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Tổng tiền</label>
                            <input class="form-control ns-readonly fw-semibold text-danger" value="@Model.TongTien.ToString("N0") đ" disabled />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm rounded-4">
                <div class="card-body">
                    <h5 class="card-title section-title"><i class="bi bi-person-vcard me-2"></i>Thông tin đặt hàng</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Họ tên</label>
                            <input class="form-control ns-readonly"
                                   value="@(string.IsNullOrWhiteSpace(Model.HoTen) ? (Model.TaiKhoan?.HoTen ?? "-") : Model.HoTen)"
                                   disabled />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input class="form-control ns-readonly"
                                   value="@(string.IsNullOrWhiteSpace(Model.SoDienThoai) ? (Model.TaiKhoan?.ThongTinNguoiDung?.SoDienThoai ?? "-") : Model.SoDienThoai)"
                                   disabled />
                        </div>

                        <div class="col-12">
                            <label class="form-label">Địa chỉ</label>
                            <textarea class="form-control ns-readonly" rows="2" disabled>@(string.IsNullOrWhiteSpace(Model.DiaChi) ? (Model.TaiKhoan?.ThongTinNguoiDung?.DiaChi ?? "-") : Model.DiaChi)</textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Phương thức thanh toán</label>
                            @{
                                var pttt = !string.IsNullOrWhiteSpace(Model.PhuongThucThanhToan)
                                ? Model.PhuongThucThanhToan
                                : Model.TaiKhoan?.ThongTinNguoiDung?.PhuongThucThanhToan;
                            }
                            <input class="form-control ns-readonly" value="@PtttText(pttt)" disabled />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ghi chú</label>
                            <input class="form-control ns-readonly"
                                   value="@(string.IsNullOrWhiteSpace(Model.GhiChu) ? (Model.TaiKhoan?.ThongTinNguoiDung?.GhiChu ?? "") : Model.GhiChu)"
                                   disabled />
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- CỘT PHẢI: CHỈNH SỬA -->
        <div class="col-lg-6">
            <div class="card shadow-sm rounded-4">
                <div class="card-body">
                    <h5 class="card-title section-title"><i class="bi bi-pencil-square me-2"></i>Cập nhật</h5>

                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">Trạng thái</label>
                            <select name="trangThai" class="form-select ns-control" asp-items="ViewBag.StatusList" required></select>
                           
                            <div class="invalid-feedback">Vui lòng chọn trạng thái.</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Ngày giao dự kiến </label>
                            <input asp-for="NgayGiao" type="date" class="form-control ns-control"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            <span asp-validation-for="NgayGiao" class="text-danger"></span>
                            
                        </div>
                    </div>

                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-gradient-green text-white"><i class="bi bi-check2-circle me-1"></i>Lưu</button>
                        <a asp-action="Index" class="btn btn-secondary text-white"><i class="bi bi-arrow-left me-1"></i>Quay lại</a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm rounded-4 mt-3">
                <div class="card-body">
                    <h5 class="card-title section-title"><i class="bi bi-bag-check me-2"></i>Sản phẩm trong đơn</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle mb-0">
                            <thead class="table-success text-center">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ct in Model.DonHangChiTiets)
                                {
                                    <tr>
                                        <td>@ct.SanPham?.Ten</td>
                                        <td class="text-end">@ct.DonGia.ToString("N0") đ</td>
                                        <td class="text-center">@ct.SoLuong</td>
                                        <td class="text-end">@((ct.DonGia * ct.SoLuong).ToString("N0")) đ</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">Tổng cộng</th>
                                    <th class="text-end text-danger fw-bold">@Model.TongTien.ToString("N0") đ</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                  
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <script>
        (() => {
            'use strict';
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(f => {
                f.addEventListener('submit', e => {
                    if (!f.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
                    f.classList.add('was-validated');
                }, false);
            });
        })();
    </script>
    <style>
        /* Header bảng xanh lá như các trang khác */
        .table thead.table-success th {
            background: #198754 !important;
            color: #fff !important;
        }

        .rounded-4 {
            border-radius: 1rem;
        }

        .section-title {
            color: #198754;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Readonly tone */
        .ns-readonly {
            background: #f8fafc;
        }

        /* Chiều cao control đồng bộ */
        .ns-control {
            height: 44px;
        }

        /* Badge đồng bộ + chữ trắng */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: .875rem;
            font-weight: 700;
            color: #fff !important;
        }

        .bg-warning.text-white {
            background-color: #ffc107 !important;
            color: #fff !important;
        }

        .bg-primary.text-white {
            background-color: #0d6efd !important;
            color: #fff !important;
        }

        .bg-info.text-white {
            background-color: #0dcaf0 !important;
            color: #fff !important;
        }

        .bg-success.text-white {
            background-color: #198754 !important;
            color: #fff !important;
        }

        .bg-danger.text-white {
            background-color: #dc3545 !important;
            color: #fff !important;
        }

        /* Nút gradient + nút phụ chữ trắng */
        .btn-gradient-green {
            background: linear-gradient(45deg,#2e7d32,#43a047);
            border: none;
            color: #fff !important;
            font-weight: 600;
            padding: .55rem 1rem;
            border-radius: .5rem;
            transition: .2s ease-in-out;
        }

            .btn-gradient-green:hover {
                filter: brightness(.95);
                transform: translateY(-1px);
            }

        .btn-secondary.text-white {
            color: #fff !important;
        }
    </style>
}
