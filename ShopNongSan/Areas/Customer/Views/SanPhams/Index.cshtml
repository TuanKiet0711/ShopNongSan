@model IEnumerable<SanPham>
@using ShopNongSan.Models.ViewModels
@{
    ViewData["Title"] = "Danh sách sản phẩm";
    var filter = ViewBag.Filter as SanPhamFilterVM ?? new SanPhamFilterVM();
    var isRateLimited = ViewBag.RateLimitMsg != null;
}

@section Head {
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

    <style>
        :root {
            --brand-green: #2e7d32;
            --brand-green-2: #1b5e20;
            --brand-green-soft: #e8f5e9;
            --gradient-primary: linear-gradient(135deg, #2e7d32, #4caf50, #66bb6a);
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Filter Section Styling */
        .filter-container {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            margin-bottom: 2rem;
            border: 1px solid rgba(46, 125, 50, 0.1);
        }

        .filter-title {
            color: var(--brand-green);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-inline {
            gap: 1rem;
        }

            .filter-inline .fi {
                min-width: 180px;
                flex: 0 0 auto;
            }

        .fi.keyword {
            flex: 1;
            min-width: 250px;
        }

        .form-label {
            font-weight: 600;
            color: var(--brand-green-2);
            margin-bottom: .5rem;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: .3s;
            padding: .75rem 1rem;
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--brand-green);
                box-shadow: 0 0 0 .2rem rgba(46,125,50,.25);
            }

        .btn-filter {
            background: var(--gradient-primary);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: #fff;
            font-weight: 600;
            transition: .3s;
            box-shadow: var(--shadow-soft);
        }

            .btn-filter:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-hover);
                color: #fff;
            }

        .btn-clear {
            border: 2px solid var(--brand-green);
            color: var(--brand-green);
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: .3s;
            background: transparent;
        }

            .btn-clear:hover {
                background: var(--brand-green);
                color: #fff;
                transform: translateY(-2px);
            }

        /* Product Cards */
        .products-container {
            margin-top: 2rem;
        }

        .product-card {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            transition: .3s;
            height: 100%;
            background: #fff;
            position: relative;
        }

            .product-card:hover {
                transform: translateY(-8px);
                box-shadow: var(--shadow-hover);
            }

        .product-image {
            height: 220px;
            object-fit: cover;
            transition: transform .3s;
            width: 100%;
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .card-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .product-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--brand-green-2);
            margin: 0;
            line-height: 1.3;
            height: 2.6rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--brand-green);
            margin: 0;
        }

        .product-meta {
            font-size: .9rem;
            color: #6c757d;
            line-height: 1.4;
        }

            .product-meta strong {
                color: var(--brand-green-2);
            }

        .product-actions {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .btn-buy-now {
            background: var(--gradient-primary);
            border: none;
            border-radius: 15px;
            padding: 12px 20px;
            color: #fff;
            font-weight: 600;
            transition: .3s;
            font-size: .95rem;
        }

            .btn-buy-now:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(46,125,50,.4);
                color: #fff;
            }

        .btn-add-cart {
            border: 2px solid var(--brand-green);
            color: var(--brand-green);
            background: transparent;
            border-radius: 15px;
            padding: 10px 20px;
            font-weight: 600;
            transition: .25s;
            font-size: .95rem;
        }

            .btn-add-cart:hover {
                background: var(--brand-green);
                color: #fff;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(46,125,50,.3);
            }

        /* Select2 */
        .select2-container .select2-results__options {
            max-height: 200px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .select2-results__option {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .select2-container--default .select2-selection--single {
            height: calc(1.5em + 1.5rem + 4px) !important;
            border-radius: 10px !important;
            border: 2px solid #e9ecef !important;
            padding: .75rem 1rem;
            display: flex;
            align-items: center;
        }

            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: normal;
                padding: 0;
            }

        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: var(--brand-green) !important;
            box-shadow: 0 0 0 .2rem rgba(46,125,50,.25);
        }

        .select2-dropdown {
            border-radius: 10px;
            border: 2px solid var(--brand-green);
            box-shadow: var(--shadow-hover);
        }

        /* Header */
        .page-header {
            background: var(--gradient-primary);
            color: #fff;
            padding: 2rem 0;
            margin: -1.5rem -15px 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

            .page-header::before {
                content: '';
                position: absolute;
                inset: 0;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.08"/></svg>');
                opacity: .3;
            }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,.2);
            position: relative;
            z-index: 2;
        }

        /* Empty */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

            .empty-state i {
                font-size: 4rem;
                color: var(--brand-green);
                margin-bottom: 1rem;
            }

        @@media (max-width: 992px) {
            .filter-inline .fi {
                min-width: 140px;
            }

            .fi.keyword {
                min-width: 200px;
            }

            .page-title {
                font-size: 2rem;
            }

            .filter-container {
                padding: 1.5rem;
            }
        }

        @@media (max-width: 768px) {
            .filter-inline {
                flex-direction: column;
            }

                .filter-inline .fi {
                    min-width: 100%;
                }

            .page-header {
                padding: 1.5rem 0;
            }

            .page-title {
                font-size: 1.8rem;
            }
        }

        /* Loading */
        .loading {
            opacity: .6;
            pointer-events: none;
        }

        .btn-loading {
            position: relative;
        }

            .btn-loading::after {
                content: '';
                position: absolute;
                width: 16px;
                height: 16px;
                margin: auto;
                border: 2px solid transparent;
                border-top-color: currentColor;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                inset: 0;
            }

        @@keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }
        /* Nút xem chi tiết: xanh dương tím nhẹ, khác hẳn 2 nút kia */
        .btn-view {
            background: linear-gradient(135deg, #4f46e5, #06b6d4); /* indigo → cyan */
            border: none;
            border-radius: 15px;
            padding: 10px 20px;
            color: #fff;
            font-weight: 600;
            transition: .25s;
            font-size: .95rem;
            box-shadow: var(--shadow-soft);
        }

            .btn-view:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-hover);
                color: #fff;
            }

    </style>
}

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1 class="page-title"><i class="bi bi-grid me-3"></i>Danh sách sản phẩm</h1>
    </div>
</div>

@if (ViewBag.RateLimitMsg != null)
{
    <div class="alert alert-warning" id="rateLimitBox" data-remaining="@ViewBag.RateLimitRemainingSeconds">
        <span id="rateLimitText">B&#7841;n &#273;ang b&#7883; gi&#7899;i h&#7841;n, vui l&#242;ng th&#7917; l&#7841;i sau </span>
        <strong id="rateLimitCountdown">@ViewBag.RateLimitRemainingSeconds</strong>
        <span> giây.</span>
    </div>
}

<!-- Filter Section -->
<div class="filter-container">
    <h3 class="filter-title"><i class="bi bi-funnel"></i>Bộ lọc sản phẩm</h3>

    <form method="get" asp-area="Customer" asp-controller="SanPhams" asp-action="Index"
          class="filter-inline d-flex flex-wrap align-items-end" id="filterForm" data-rate-limited="@(isRateLimited ? "true" : "false")">

        <div class="fi keyword">
            <label class="form-label"><i class="bi bi-search me-1"></i>Từ khóa</label>
            <input type="text" name="Q" value="@(filter.Q ?? "")" class="form-control" placeholder="Nhập tên sản phẩm...">
        </div>

        <div class="fi">
            <label class="form-label"><i class="bi bi-tags me-1"></i>Danh mục</label>
            <select name="DanhMucId" class="form-select js-select2" asp-items="ViewBag.DanhMucList" data-placeholder="-- Tất cả danh mục --">
                <option value="">-- Tất cả danh mục --</option>
            </select>
        </div>

        <div class="fi">
            <label class="form-label"><i class="bi bi-award me-1"></i>Thương hiệu</label>
            <select name="ThuongHieuId" class="form-select js-select2" asp-items="ViewBag.ThuongHieuList" data-placeholder="-- Tất cả thương hiệu --">
                <option value="">-- Tất cả thương hiệu --</option>
            </select>
        </div>

        <div class="fi">
            <label class="form-label"><i class="bi bi-sort-down me-1"></i>Sắp xếp</label>
            <select name="Sort" class="form-select" @(isRateLimited ? "disabled=\"disabled\"" : "")>
                <option value="" selected="@(string.IsNullOrEmpty(filter.Sort))">Theo tên (A→Z)</option>
                <option value="price_asc" selected="@(filter.Sort == "price_asc")">Giá: Thấp → Cao</option>
                <option value="price_desc" selected="@(filter.Sort == "price_desc")">Giá: Cao → Thấp</option>
                <option value="newest" selected="@(filter.Sort == "newest")">Mới nhất</option>
            </select>
        </div>

        <!-- Price Range -->
        <div class="w-100 d-flex flex-wrap gap-3 mt-3">
            <div class="fi" style="min-width: 160px;">
                <label class="form-label"><i class="bi bi-currency-exchange me-1"></i>Giá từ</label>
                <div class="input-group">
                    <input type="text" name="GiaMinStr" value="@(filter.GiaMinStr ?? "")" class="form-control vnd-only" placeholder="0" inputmode="numeric" @(isRateLimited ? "disabled=\"disabled\"" : "")>
                    <span class="input-group-text">đ</span>
                </div>
            </div>
            <div class="fi" style="min-width: 160px;">
                <label class="form-label">đến</label>
                <div class="input-group">
                    <input type="text" name="GiaMaxStr" value="@(filter.GiaMaxStr ?? "")" class="form-control vnd-only" placeholder="999,999,999" inputmode="numeric" @(isRateLimited ? "disabled=\"disabled\"" : "")>
                    <span class="input-group-text">đ</span>
                </div>
            </div>
        </div>

        <div class="d-flex align-items-end gap-3 mt-3">
            <button type="submit" class="btn btn-filter" id="filterBtn" @(isRateLimited ? "disabled=\"disabled\"" : "")>
                <i class="bi bi-funnel-fill me-2"></i>Áp dụng lọc
            </button>
            <a asp-area="Customer" asp-controller="SanPhams" asp-action="Index" class="btn btn-clear">
                <i class="bi bi-arrow-clockwise me-2"></i>Xóa bộ lọc
            </a>
        </div>
    </form>
</div>

<!-- Products -->
<div class="products-container">
    <div class="row g-4" id="sanpham">
        @if (Model != null && Model.Any())
        {
            foreach (var sp in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="product-card card">
                        <div class="position-relative overflow-hidden">
                            <img src="@(string.IsNullOrEmpty(sp.HinhAnh) ? Url.Content("~/images/no-image.png") : sp.HinhAnh)"
                                 class="product-image" alt="@sp.Ten" />
                        </div>

                        <div class="card-body">
                            <h5 class="product-title" title="@sp.Ten">@sp.Ten</h5>
                            <div class="product-price">@sp.Gia.ToString("N0") đ</div>

                            <div class="product-meta">
                                <div><strong>Danh mục:</strong> @(sp.DanhMuc?.Ten ?? "Chưa phân loại")</div>
                                @if (sp.ThuongHieu != null)
                                {
                                    <div><strong>Thương hiệu:</strong> @sp.ThuongHieu.Ten</div>
                                }
                            </div>
                            @{
                                bool isSignedIn = User?.Identity?.IsAuthenticated == true; // thay cho isCustomer
                            }
                            <div class="product-actions">
                                <!-- Mua ngay: giữ nguyên submit thường -->
                                <form asp-area="Customer" asp-controller="DonHangs" asp-action="BuyNow" method="post" class="buy-now-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@sp.Id" />
                                    <input type="hidden" name="qty" value="1" />
                                    <input type="hidden" name="returnUrl" value="@(Context?.Request?.Path + Context?.Request?.QueryString)" />
                                    <button type="submit" class="btn btn-buy-now w-100">
                                        <i class="bi bi-lightning-charge-fill me-2"></i>Mua ngay
                                    </button>
                                </form>
                                <a asp-area="Customer" asp-controller="SanPhams" asp-action="Details" asp-route-id="@sp.Id"
                                   class="btn btn-view w-100">
                                    <i class="bi bi-eye me-2"></i>Xem chi tiết
                                </a>

                                @if (isSignedIn)
                                {
                                    <!-- ĐÃ đăng nhập: dùng AJAX -->
                                    <form asp-area="Customer" asp-controller="GioHang" asp-action="AddAjax" method="post"
                                          class="add-cart-form" data-ajax="true">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@sp.Id" />
                                        <input type="hidden" name="qty" value="1" />
                                        <button type="submit" class="btn btn-add-cart w-100">
                                            <i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <!-- CHƯA đăng nhập: post thường để redirect Login -->
                                    <form asp-area="Customer" asp-controller="GioHang" asp-action="Add" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@sp.Id" />
                                        <input type="hidden" name="qty" value="1" />
                                        <input type="hidden" name="returnUrl" value="@(Context?.Request?.Path + Context?.Request?.QueryString)" />
                                        <button type="submit" class="btn btn-add-cart w-100">
                                            <i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ
                                        </button>
                                    </form>
                                }
                            </div>

                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>Không tìm thấy sản phẩm nào</h4>
                    <p>Hãy thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                    <a asp-area="Customer" asp-controller="SanPhams" asp-action="Index" class="btn btn-filter">
                        <i class="bi bi-arrow-clockwise me-2"></i>Xem tất cả sản phẩm
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        (function initRateLimit(){
            const box = document.getElementById('rateLimitBox');
            if (!box) return;

            const form = document.getElementById('filterForm');
            const remaining = Number(box.dataset.remaining || 0);
            let seconds = Number.isFinite(remaining) ? remaining : 0;

            function setDisabled(disabled){
                if (!form) return;
                form.dataset.rateLimited = disabled ? 'true' : 'false';
                form.querySelectorAll('input, select, button').forEach(el => {
                    el.disabled = disabled;
                });
            }

            function render(){
                const label = document.getElementById('rateLimitText');
                const countdown = document.getElementById('rateLimitCountdown');

                if (seconds <= 0){
                    if (label) { label.textContent = '\u0110\u00e3 h\u1ebft gi\u1edbi h\u1ea1n, b\u1ea1n c\u00f3 th\u1ec3 ti\u1ebfp t\u1ee5c t\u00ecm ki\u1ebfm.'; }
                    if (countdown) { countdown.textContent = ''; }
                    setDisabled(false);
                    return;
                }

                if (label) { label.textContent = '\u0110ang b\u1ecb gi\u1edbi h\u1ea1n, vui l\u00f2ng th\u1eed l\u1ea1i sau '; }
                if (countdown) { countdown.textContent = seconds.toString(); }
                setDisabled(true);
            }

            render();
            if (seconds > 0){
                const timer = setInterval(() => {
                    seconds -= 1;
                    if (seconds <= 0){
                        clearInterval(timer);
                    }
                    render();
                }, 1000);
            }

            if (form){
                form.addEventListener('submit', e => {
                    if (form.dataset.rateLimited === 'true'){
                        e.preventDefault();
                    }
                });

                form.addEventListener('keydown', e => {
                    if (form.dataset.rateLimited === 'true' && e.key === 'Enter'){
                        e.preventDefault();
                    }
                });
            }
        })();
    </script>

    <script>
        // Keyframes cho fadeInUp
        (function appendKeyframes(){ const s=document.createElement('style'); s.textContent=`@@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}`; document.head.appendChild(s); })();

        $(function () {
            // Number formatting vi-VN
            const nf = new Intl.NumberFormat('vi-VN');
            function formatNumeric(el){ const digits=(el.value||"").replace(/\D+/g,""); el.value = digits ? nf.format(parseInt(digits,10)) : ""; }
            document.querySelectorAll(".vnd-only").forEach(el => { el.addEventListener("input", () => formatNumeric(el)); if (el.value) formatNumeric(el); });

            // Select2
            $('.js-select2').select2({ width:'100%', placeholder: function(){ return $(this).data('placeholder') || '-- Tất cả --'; }, allowClear:true, minimumResultsForSearch:3 });

            // Filter button loading (chỉ UX nhẹ, có thể bỏ)
            $('#filterForm').on('submit', function () {
                const $btn = $('#filterBtn');
                $btn.addClass('btn-loading').prop('disabled', true);
                $btn.find('i').removeClass('bi-funnel-fill').addClass('d-none');
                $btn.append('<span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>');
            });

            // Intersection animation cho card
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(e => { if (e.isIntersecting) { e.target.style.animationDelay = `${Math.random()*0.3}s`; e.target.style.animation = 'fadeInUp .6s ease-out forwards'; }});
            }, { threshold: 0.1 });
            document.querySelectorAll('.product-card').forEach(card => observer.observe(card));

            // Loading state nút submit
            $('form.buy-now-form, form.add-cart-form').on('submit', function () {
                const $btn = $(this).find('button[type="submit"]');
                if (!$btn.length) return;
                const isBuyNow = $btn.hasClass('btn-buy-now');
                $btn.addClass('btn-loading').prop('disabled', true).data('__orig', $btn.html());
                $btn.html(isBuyNow ? '<i class="bi bi-hourglass-split me-2"></i>Đang xử lý...' : '<i class="bi bi-hourglass-split me-2"></i>Đang thêm...');
            });

            // ✅ AJAX cho Thêm giỏ (không reload)
            $('form.add-cart-form[data-ajax="true"]').on('submit', async function (e) {
                e.preventDefault();
                const form = this;
                const $btn = $(form).find('button[type="submit"]');

                try {
                    const token = $(form).find('input[name="__RequestVerificationToken"]').val();
                    const url = form.getAttribute('action') || '@Url.Action("AddAjax", "GioHang", new { area = "Customer" })';
                    const fd = new FormData(form);

                    const res = await fetch(url, {
                        method: 'POST',
                        headers: token ? { 'RequestVerificationToken': token } : {},
                        body: fd
                    });
                    const data = await res.json();

                    if (!res.ok || !data || data.ok !== true) {
                        const msg = (data && data.message) ? data.message : 'Có lỗi xảy ra khi thêm vào giỏ.';
                        if (window.showToast) showToast(msg, 'danger');
                    } else {
                        updateCartBadge(data.cartCount);
                        if (window.showToast) showToast(data.message, 'success');
                    }
                } catch (err) {
                    if (window.showToast) showToast('Không thể kết nối máy chủ.', 'danger');
                } finally {
                    if ($btn.length) {
                        const orig = $btn.data('__orig');
                        $btn.removeClass('btn-loading').prop('disabled', false);
                        if (orig) $btn.html(orig);
                    }
                }
            });

            // Cập nhật badge giỏ ở navbar (layout có #cart-link)
            function updateCartBadge(count){
                const cartBtn = document.getElementById('cart-link')
                               || document.querySelector('a[href*="/Customer/GioHang"]')
                               || document.querySelector('a:has(> i.bi-basket)');
                if (!cartBtn) return;
                let badge = cartBtn.querySelector('.badge.rounded-pill');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                    cartBtn.appendChild(badge);
                }
                if (count && count > 0) {
                    badge.textContent = count;
                    badge.style.display = '';
                } else {
                    badge.textContent = '';
                    badge.style.display = 'none';
                }
            }
        });
    </script>
}
