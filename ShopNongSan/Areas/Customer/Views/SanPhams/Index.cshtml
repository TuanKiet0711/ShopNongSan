@model IEnumerable<SanPham>
@using ShopNongSan.Models.ViewModels
@{
    ViewData["Title"] = "Danh sách sản phẩm";
    var filter = ViewBag.Filter as SanPhamFilterVM ?? new SanPhamFilterVM();
}

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

<style>
    .filter-inline {
        gap: .5rem 1rem;
    }

        .filter-inline .fi {
            min-width: 180px;
        }

    @@media (max-width: 992px) {
        .filter-inline .fi {
            min-width: 140px;
        }
    }

    /* Từ khóa dài ra */
    .filter-inline .fi.keyword {
        flex: 0 0 250px; /* chiếm rộng hơn, tối thiểu 300px */
    }

        .filter-inline .fi.keyword input {
            width: 100%;
        }

    /* Tuỳ biến Select2: list ngắn lại, ô hiển thị nhỏ gọn */
    .select2-container .select2-results__options {
        max-height: 140px !important;
        overflow-y: auto !important;
    }

    .select2-container--default .select2-selection--single {
        height: calc(1.5em + .5rem + 2px);
        padding: .25rem .5rem;
        border-radius: .25rem;
        display: flex;
        align-items: center;
        border: 1px solid #ced4da;
        font-size: .875rem;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: normal;
            padding-left: 0;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100%;
            right: .5rem;
        }

    .select2-dropdown .select2-search__field {
        padding: .25rem .5rem;
        font-size: .875rem;
    }

    /* Danh mục & Thương hiệu dài hơn */
    select[name="DanhMucId"] + .select2,
    select[name="ThuongHieuId"] + .select2 {
        min-width: 240px !important;
        width: 240px !important;
    }
</style>

<!-- Hero Banner -->
<div class="hero-banner position-relative mb-4" style="height: 350px; border-radius: 12px; overflow: hidden;">
    <img src="~/images/banner.png" alt="Nông sản sạch"
         class="w-100 h-100"
         style="object-fit: cover; filter: brightness(0.75);" />

    <div class="position-absolute top-50 start-50 translate-middle text-center text-white px-3">
        <h1 class="fw-bold display-5">🌱 Nông Sản Sạch</h1>
        <p class="lead">Thực phẩm tươi ngon – An toàn cho mọi gia đình</p>
        <a href="#sanpham" class="btn btn-light btn-lg mt-3 shadow-sm">Khám phá ngay</a>
    </div>
</div>

<h2 class="mb-4">Danh sách sản phẩm</h2>

<form method="get" asp-area="Customer" asp-controller="SanPhams" asp-action="Index"
      class="filter-inline d-flex flex-wrap align-items-end mb-4">

    <div class="fi keyword">
        <label class="form-label mb-1 small">Từ khóa</label>
        <input type="text" name="Q" value="@(filter.Q ?? "")"
               class="form-control form-control-sm" placeholder="Tên sản phẩm...">
    </div>

    <div class="fi">
        <label class="form-label mb-1 small">Danh mục</label>
        <select name="DanhMucId" class="form-select form-select-sm js-select2" asp-items="ViewBag.DanhMucList" data-placeholder="-- Tất cả --">
            <option value="">-- Tất cả --</option>
        </select>
    </div>

    <div class="fi">
        <label class="form-label mb-1 small">Thương hiệu</label>
        <select name="ThuongHieuId" class="form-select form-select-sm js-select2" asp-items="ViewBag.ThuongHieuList" data-placeholder="-- Tất cả --">
            <option value="">-- Tất cả --</option>
        </select>
    </div>

    <div class="fi">
        <label class="form-label mb-1 small">Sắp xếp</label>
        <select name="Sort" class="form-select form-select-sm">
            <option value="" selected="@(string.IsNullOrEmpty(filter.Sort))">Theo tên (A→Z)</option>
            <option value="price_asc" selected="@(filter.Sort == "price_asc")">Giá: Thấp → Cao</option>
            <option value="price_desc" selected="@(filter.Sort == "price_desc")">Giá: Cao → Thấp</option>
            <option value="newest" selected="@(filter.Sort == "newest")">Mới nhất</option>
        </select>
    </div>

    <!-- Xuống hàng cho khoảng giá -->
    <div class="w-100 d-flex flex-wrap gap-3 mt-2">
        <div class="fi">
            <label class="form-label mb-1 small">Giá từ</label>
            <div class="input-group input-group-sm">
                <input type="text" name="GiaMinStr" id="GiaMinStr"
                       value="@(filter.GiaMinStr ?? "")"
                       class="form-control vnd-only"
                       inputmode="numeric">
                <span class="input-group-text">đ</span>
            </div>
        </div>

        <div class="fi">
            <label class="form-label mb-1 small">đến</label>
            <div class="input-group input-group-sm">
                <input type="text" name="GiaMaxStr" id="GiaMaxStr"
                       value="@(filter.GiaMaxStr ?? "")"
                       class="form-control vnd-only"
                       inputmode="numeric">
                <span class="input-group-text">đ</span>
            </div>
        </div>
    </div>

    <div class="d-flex align-items-end mb-1 mt-2" style="gap:.5rem">
        <button type="submit" class="btn btn-sm btn-primary">Lọc</button>
        <a asp-area="Customer" asp-controller="SanPhams" asp-action="Index" class="btn btn-sm btn-outline-secondary">Xoá lọc</a>
    </div>
</form>

<div class="row" id="sanpham">
    @foreach (var sp in Model)
    {
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm h-100">
                <img src="@(string.IsNullOrEmpty(sp.HinhAnh) ? Url.Content("~/images/no-image.png") : sp.HinhAnh)"
                     class="card-img-top" alt="@sp.Ten" style="height:200px; object-fit:cover;" />
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">@sp.Ten</h5>
                    <p class="card-text text-muted">
                        Giá: <b>@sp.Gia.ToString("N0") đ</b><br />
                        Danh mục: @sp.DanhMuc?.Ten <br />
                        @if (sp.ThuongHieu != null)
                        {
                            <span>Thương hiệu: @sp.ThuongHieu.Ten</span>
                        }
                    </p>

                    <div class="mt-auto d-grid gap-2">
                        <form asp-area="Customer" asp-controller="DonHangs" asp-action="BuyNow" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@sp.Id" />
                            <input type="hidden" name="qty" value="1" />
                            <input type="hidden" name="returnUrl" value="@(Context?.Request?.Path + Context?.Request?.QueryString)" />
                            <button type="submit" class="btn btn-sm btn-success w-100">Mua hàng</button>
                        </form>

                        <form asp-area="Customer" asp-controller="GioHang" asp-action="Add" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@sp.Id" />
                            <input type="hidden" name="qty" value="1" />
                            <button type="submit" class="btn btn-sm btn-outline-primary w-100">Thêm vào giỏ hàng</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // Format số theo vi-VN
        const nf = new Intl.NumberFormat('vi-VN');
        function formatNumeric(el){
            const digits = (el.value || "").replace(/\D+/g, "");
            el.value = digits ? nf.format(parseInt(digits,10)) : "";
        }
        document.querySelectorAll(".vnd-only").forEach(el=>{
            el.addEventListener("input", ()=>formatNumeric(el));
            if (el.value) formatNumeric(el);
        });

        // Khởi tạo Select2
        $(function () {
            $('.js-select2').select2({
                width: 'resolve',
                placeholder: function(){ return $(this).data('placeholder') || '-- Tất cả --'; },
                allowClear: true,
                minimumResultsForSearch: 0
            });
        });
    </script>
}
