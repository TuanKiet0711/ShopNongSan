@model IEnumerable<SanPham>
@using ShopNongSan.Models.ViewModels
@{
    ViewData["Title"] = "Danh sách sản phẩm";
    var filter = ViewBag.Filter as SanPhamFilterVM ?? new SanPhamFilterVM();
}

@section Head {
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

    <style>
        :root {
            --brand-green: #2e7d32;
            --brand-green-2: #1b5e20;
            --brand-green-soft: #e8f5e9;
            --gradient-primary: linear-gradient(135deg, #2e7d32, #4caf50, #66bb6a);
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Filter Section Styling */
        .filter-container {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            margin-bottom: 2rem;
            border: 1px solid rgba(46, 125, 50, 0.1);
        }

        .filter-title {
            color: var(--brand-green);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-inline {
            gap: 1rem;
        }

            .filter-inline .fi {
                min-width: 180px;
                flex: 0 0 auto;
            }

        .fi.keyword {
            flex: 1;
            min-width: 250px;
        }

        .form-label {
            font-weight: 600;
            color: var(--brand-green-2);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            padding: 0.75rem 1rem;
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--brand-green);
                box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
            }

        .btn-filter {
            background: var(--gradient-primary);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

            .btn-filter:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-hover);
                color: white;
            }

        .btn-clear {
            border: 2px solid var(--brand-green);
            color: var(--brand-green);
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: transparent;
        }

            .btn-clear:hover {
                background: var(--brand-green);
                color: white;
                transform: translateY(-2px);
            }

        /* Product Cards Styling */
        .products-container {
            margin-top: 2rem;
        }

        .product-card {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            height: 100%;
            background: white;
            position: relative;
        }

            .product-card:hover {
                transform: translateY(-8px);
                box-shadow: var(--shadow-hover);
            }

        .product-image {
            height: 220px;
            object-fit: cover;
            transition: transform 0.3s ease;
            width: 100%;
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .card-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .product-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--brand-green-2);
            margin: 0;
            line-height: 1.3;
            height: 2.6rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--brand-green);
            margin: 0;
        }

        .product-meta {
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.4;
        }

            .product-meta strong {
                color: var(--brand-green-2);
            }

        .product-actions {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn-buy-now {
            background: var(--gradient-primary);
            border: none;
            border-radius: 15px;
            padding: 12px 20px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

            .btn-buy-now:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(46, 125, 50, 0.4);
                color: white;
            }

        .btn-add-cart {
            border: 2px solid var(--brand-green);
            color: var(--brand-green);
            background: transparent;
            border-radius: 15px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

            .btn-add-cart:hover {
                background: var(--brand-green);
                color: white;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
            }

        /* Select2 Customization */
        .select2-container .select2-results__options {
            max-height: 200px !important;
        }

        .select2-container--default .select2-selection--single {
            height: calc(1.5em + 1.5rem + 4px) !important;
            border-radius: 10px !important;
            border: 2px solid #e9ecef !important;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
        }

            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: normal;
                padding: 0;
            }

        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: var(--brand-green) !important;
            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
        }

        .select2-dropdown {
            border-radius: 10px;
            border: 2px solid var(--brand-green);
            box-shadow: var(--shadow-hover);
        }

        /* Page Header */
        .page-header {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem 0;
            margin: -1.5rem -15px 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

            .page-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.08"/></svg>');
                opacity: 0.3;
            }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

            .empty-state i {
                font-size: 4rem;
                color: var(--brand-green);
                margin-bottom: 1rem;
            }

        /* Responsive Design */
        @@media (max-width: 992px) {
            .filter-inline .fi

        {
            min-width: 140px;
        }

        .fi.keyword {
            min-width: 200px;
        }

        .page-title {
            font-size: 2rem;
        }

        .filter-container {
            padding: 1.5rem;
        }

        }

        @@media (max-width: 768px) {
            .filter-inline

        {
            flex-direction: column;
        }

        .filter-inline .fi {
            min-width: 100%;
        }

        .page-header {
            padding: 1.5rem 0;
        }

        .page-title {
            font-size: 1.8rem;
        }

        }

        /* Loading Animation */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .btn-loading {
            position: relative;
        }

            .btn-loading::after {
                content: '';
                position: absolute;
                width: 16px;
                height: 16px;
                margin: auto;
                border: 2px solid transparent;
                border-top-color: currentColor;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }

        @@keyframes spin {
            0%

        {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }

        }
    </style>
}

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1 class="page-title">
            <i class="bi bi-grid me-3"></i>Danh sách sản phẩm
        </h1>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-container">
    <h3 class="filter-title">
        <i class="bi bi-funnel"></i>
        Bộ lọc sản phẩm
    </h3>

    <form method="get" asp-area="Customer" asp-controller="SanPhams" asp-action="Index"
          class="filter-inline d-flex flex-wrap align-items-end" id="filterForm">

        <div class="fi keyword">
            <label class="form-label">
                <i class="bi bi-search me-1"></i>Từ khóa
            </label>
            <input type="text" name="Q" value="@(filter.Q ?? "")"
                   class="form-control" placeholder="Nhập tên sản phẩm...">
        </div>

        <div class="fi">
            <label class="form-label">
                <i class="bi bi-tags me-1"></i>Danh mục
            </label>
            <select name="DanhMucId" class="form-select js-select2" asp-items="ViewBag.DanhMucList" data-placeholder="-- Tất cả danh mục --">
                <option value="">-- Tất cả danh mục --</option>
            </select>
        </div>

        <div class="fi">
            <label class="form-label">
                <i class="bi bi-award me-1"></i>Thương hiệu
            </label>
            <select name="ThuongHieuId" class="form-select js-select2" asp-items="ViewBag.ThuongHieuList" data-placeholder="-- Tất cả thương hiệu --">
                <option value="">-- Tất cả thương hiệu --</option>
            </select>
        </div>

        <div class="fi">
            <label class="form-label">
                <i class="bi bi-sort-down me-1"></i>Sắp xếp
            </label>
            <select name="Sort" class="form-select">
                <option value="" selected="@(string.IsNullOrEmpty(filter.Sort))">Theo tên (A→Z)</option>
                <option value="price_asc" selected="@(filter.Sort == "price_asc")">Giá: Thấp → Cao</option>
                <option value="price_desc" selected="@(filter.Sort == "price_desc")">Giá: Cao → Thấp</option>
                <option value="newest" selected="@(filter.Sort == "newest")">Mới nhất</option>
            </select>
        </div>

        <!-- Price Range -->
        <div class="w-100 d-flex flex-wrap gap-3 mt-3">
            <div class="fi" style="min-width: 160px;">
                <label class="form-label">
                    <i class="bi bi-currency-exchange me-1"></i>Giá từ
                </label>
                <div class="input-group">
                    <input type="text" name="GiaMinStr"
                           value="@(filter.GiaMinStr ?? "")"
                           class="form-control vnd-only"
                           placeholder="0"
                           inputmode="numeric">
                    <span class="input-group-text">đ</span>
                </div>
            </div>

            <div class="fi" style="min-width: 160px;">
                <label class="form-label">đến</label>
                <div class="input-group">
                    <input type="text" name="GiaMaxStr"
                           value="@(filter.GiaMaxStr ?? "")"
                           class="form-control vnd-only"
                           placeholder="999,999,999"
                           inputmode="numeric">
                    <span class="input-group-text">đ</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex align-items-end gap-3 mt-3">
            <button type="submit" class="btn btn-filter" id="filterBtn">
                <i class="bi bi-funnel-fill me-2"></i>
                Áp dụng lọc
            </button>
            <a asp-area="Customer" asp-controller="SanPhams" asp-action="Index" class="btn btn-clear">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Xóa bộ lọc
            </a>
        </div>
    </form>
</div>

<!-- Products Container -->
<div class="products-container">
    <div class="row g-4" id="sanpham">
        @if (Model != null && Model.Any())
        {
            foreach (var sp in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="product-card card">
                        <div class="position-relative overflow-hidden">
                            <img src="@(string.IsNullOrEmpty(sp.HinhAnh) ? Url.Content("~/images/no-image.png") : sp.HinhAnh)"
                                 class="product-image" alt="@sp.Ten" />
                        </div>

                        <div class="card-body">
                            <h5 class="product-title" title="@sp.Ten">@sp.Ten</h5>

                            <div class="product-price">
                                @sp.Gia.ToString("N0") đ
                            </div>

                            <div class="product-meta">
                                <div><strong>Danh mục:</strong> @(sp.DanhMuc?.Ten ?? "Chưa phân loại")</div>
                                @if (sp.ThuongHieu != null)
                                {
                                    <div><strong>Thương hiệu:</strong> @sp.ThuongHieu.Ten</div>
                                }
                            </div>

                            <div class="product-actions">
                                <!-- Mua ngay -->
                                <form asp-area="Customer" asp-controller="DonHangs" asp-action="BuyNow" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@sp.Id" />
                                    <input type="hidden" name="qty" value="1" />
                                    <input type="hidden" name="returnUrl" value="@(Context?.Request?.Path + Context?.Request?.QueryString)" />
                                    <button type="submit" class="btn btn-buy-now w-100">
                                        <i class="bi bi-lightning-charge-fill me-2"></i>
                                        Mua ngay
                                    </button>
                                </form>

                                <!-- Thêm vào giỏ -->
                                <form asp-area="Customer" asp-controller="GioHang" asp-action="Add" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@sp.Id" />
                                    <input type="hidden" name="qty" value="1" />
                                    <button type="submit" class="btn btn-add-cart w-100">
                                        <i class="bi bi-cart-plus me-2"></i>
                                        Thêm vào giỏ
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>Không tìm thấy sản phẩm nào</h4>
                    <p>Hãy thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                    <a asp-area="Customer" asp-controller="SanPhams" asp-action="Index" class="btn btn-filter">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Xem tất cả sản phẩm
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // Format số theo vi-VN
            const nf = new Intl.NumberFormat('vi-VN');

            function formatNumeric(el) {
                const digits = (el.value || "").replace(/\D+/g, "");
                el.value = digits ? nf.format(parseInt(digits, 10)) : "";
            }

            // Áp dụng format cho input giá
            document.querySelectorAll(".vnd-only").forEach(el => {
                el.addEventListener("input", () => formatNumeric(el));
                if (el.value) formatNumeric(el);
            });

            // Khởi tạo Select2
            $('.js-select2').select2({
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder') || '-- Tất cả --';
                },
                allowClear: true,
                minimumResultsForSearch: 3
            });

            // Form submit với loading state
            $('#filterForm').on('submit', function() {
                const $btn = $('#filterBtn');
                $btn.addClass('btn-loading').prop('disabled', true);
                $btn.find('i').removeClass('bi-funnel-fill').addClass('d-none');
                $btn.append('<span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>');

                // Simulate loading (remove in production)
                setTimeout(() => {
                    $btn.removeClass('btn-loading').prop('disabled', false);
                    $btn.find('.spinner-border').remove();
                    $btn.find('i').addClass('bi-funnel-fill').removeClass('d-none');
                }, 1000);
            });

            // Button loading states for product actions
            $('form[asp-action="BuyNow"], form[asp-action="Add"]').on('submit', function(e) {
                const $btn = $(this).find('button[type="submit"]');
                $btn.addClass('btn-loading').prop('disabled', true);

                // Add loading text
                const originalText = $btn.html();
                const loadingText = $btn.hasClass('btn-buy-now') ?
                    '<i class="bi bi-hourglass-split me-2"></i>Đang xử lý...' :
                    '<i class="bi bi-hourglass-split me-2"></i>Đang thêm...';

                $btn.html(loadingText);

                // Reset after delay (for demo purposes)
                setTimeout(() => {
                    $btn.removeClass('btn-loading').prop('disabled', false).html(originalText);
                }, 2000);
            });

            // Smooth animations on scroll
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animationDelay = `${Math.random() * 0.3}s`;
                        entry.target.style.animation = 'fadeInUp 0.6s ease-out forwards';
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.product-card').forEach(card => {
                observer.observe(card);
            });
        });

        // Add CSS animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
}