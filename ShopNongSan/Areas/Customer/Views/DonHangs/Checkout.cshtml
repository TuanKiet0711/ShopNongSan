@model ShopNongSan.Models.ViewModels.CheckoutVM
@{
    ViewData["Title"] = "Thông tin giao hàng";
}

<h2 class="mb-3">Thông tin giao hàng</h2>

<div class="row g-4">
    <div class="col-lg-5">
        <div class="card shadow-sm rounded-4">
            <div class="card-body">
                <form asp-area="Customer" asp-controller="DonHangs" asp-action="Place" method="post" class="row g-3">
                    @Html.AntiForgeryToken()

                    <!-- ==== HIDDEN cho mua ngay ==== -->
                    <input type="hidden" asp-for="IsBuyNow" />
                    <input type="hidden" asp-for="BuyNowSanPhamId" />
                    <input type="hidden" asp-for="BuyNowSoLuong" />

                    <div class="col-12">
                        <label class="form-label">Họ tên người nhận</label>
                        <input asp-for="HoTen" class="form-control" placeholder="Nhập họ và tên" />
                        <span asp-validation-for="HoTen" class="text-danger"></span>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Số điện thoại</label>
                        <input asp-for="SoDienThoai"
                               class="form-control"
                               placeholder="Nhập số điện thoại"
                               inputmode="numeric"
                               pattern="[0-9]*"
                               maxlength="11"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                               onpaste="return false"
                               ondrop="return false" />
                        <span asp-validation-for="SoDienThoai" class="text-danger"></span>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Địa chỉ giao hàng</label>
                        <textarea asp-for="DiaChi" class="form-control" rows="3"
                                  placeholder="Nhập địa chỉ giao hàng"></textarea>
                        <span asp-validation-for="DiaChi" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Ghi chú (tuỳ chọn)</label>
                        <textarea asp-for="GhiChu" class="form-control" rows="2"
                                  placeholder="Ví dụ: Giao giờ hành chính, gọi trước khi đến..."></textarea>
                        <span asp-validation-for="GhiChu" class="text-danger"></span>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Ngày giao hàng mong muốn</label>
                        <input asp-for="NgayGiao" type="date" class="form-control"
                               min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="NgayGiao" class="text-danger"></span>
                    </div>

                    <!---------------------- PHƯƠNG THỨC THANH TOÁN -------------------------->
                    <div class="col-12">
                        <label class="form-label d-block">Phương thức thanh toán</label>

                        <div class="form-check mb-1">
                            <input class="form-check-input" type="radio" asp-for="PhuongThucThanhToan" value="COD" id="pmCOD" />
                            <label class="form-check-label" for="pmCOD">Thanh toán khi nhận hàng (COD)</label>
                        </div>

                        @* <div class="form-check mb-1">
                            <input class="form-check-input" type="radio" asp-for="PhuongThucThanhToan" value="VNPAY" id="pmVNPAY" />
                            <label class="form-check-label" for="pmVNPAY">VNPAY (thanh toán trực tuyến)</label>
                        </div> *@

                        <div class="form-check mb-1">
                            <input class="form-check-input" type="radio" asp-for="PhuongThucThanhToan" value="STRIPE" id="pmSTRIPE" />
                            <label class="form-check-label" for="pmSTRIPE">Stripe (thanh toán bằng thẻ)</label>
                        </div>

                        <span asp-validation-for="PhuongThucThanhToan" class="text-danger"></span>

                        <div id="vnpayInfo" class="alert alert-secondary mt-2" style="display:none">
                            <div class="small"><b>VNPAY</b> sẽ chuyển bạn đến cổng thanh toán an toàn để hoàn tất.</div>
                        </div>

                        <div id="stripeInfo" class="alert alert-info mt-2" style="display:none">
                            <div class="small">
                                <b>Stripe</b> sẽ chuyển bạn đến trang thanh toán bằng thẻ Visa/Master/JCB.
                            </div>
                        </div>
                    </div>
                    <!---------------------- END PHƯƠNG THỨC -------------------------->

                    <div class="col-12 d-flex gap-2">
                        <a asp-area="Customer" asp-controller="GioHang" asp-action="Index"
                           class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Quay lại giỏ
                        </a>
                        <button type="submit" class="btn btn-success ms-auto">
                            <i class="bi bi-check2-circle"></i> Xác nhận đặt hàng
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CỘT TÓM TẮT ĐƠN -->
    <div class="col-lg-7">
        <div class="card shadow-sm rounded-4">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-bag-check me-2"></i>Tóm tắt đơn</h5>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-success">
                            <tr>
                                <th style="width:70px">Ảnh</th>
                                <th>Sản phẩm</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-center">SL</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <img src="@(string.IsNullOrEmpty(i.HinhAnh) ? Url.Content("~/images/no-image.png") : Url.Content(i.HinhAnh))"
                                             style="width:60px;height:60px;object-fit:cover;border-radius:8px" />
                                    </td>
                                    <td>@i.TenSanPham</td>
                                    <td class="text-end">@i.DonGia.ToString("N0") đ</td>
                                    <td class="text-center">@i.SoLuong</td>
                                    <td class="text-end">@i.ThanhTien.ToString("N0") đ</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="4" class="text-end">Tổng cộng</th>
                                <th class="text-end text-success fw-bold">@Model.TongTien.ToString("N0") đ</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <p class="text-muted small mb-0">
                    Giá đã bao gồm VAT (nếu có). Phí vận chuyển sẽ được tính theo địa chỉ giao hàng của bạn.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <script>
        // Show/hide thông báo theo phương thức thanh toán
        function togglePaymentInfo() {
            var checked = document.querySelector('input[name="PhuongThucThanhToan"]:checked');
            var v = checked ? checked.value : null;

            document.getElementById('vnpayInfo').style.display = (v === 'VNPAY') ? 'block' : 'none';
            document.getElementById('stripeInfo').style.display = (v === 'STRIPE') ? 'block' : 'none';
        }

        document.addEventListener('change', function (e) {
            if (e.target.name === 'PhuongThucThanhToan') togglePaymentInfo();
        });
        document.addEventListener('DOMContentLoaded', togglePaymentInfo);

        // Giới hạn chỉ số cho ô điện thoại
        document.addEventListener('DOMContentLoaded', function () {
            const phoneInput = document.querySelector('input[name="SoDienThoai"]');
            if (!phoneInput) return;
            phoneInput.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            phoneInput.addEventListener('keypress', function (e) {
                if (e.key < '0' || e.key > '9') e.preventDefault();
            });
            phoneInput.addEventListener('paste', e => e.preventDefault());
            phoneInput.addEventListener('drop', e => e.preventDefault());
        });
    </script>

    <style>
        .rounded-4 {
            border-radius: 1rem;
        }

        .table thead.table-success th {
            background-color: #198754 !important;
            color: #fff !important;
        }

        textarea::placeholder, input::placeholder {
            color: #999;
            font-style: italic;
        }
    </style>
}
