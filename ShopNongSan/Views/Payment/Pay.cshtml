@using System.Globalization

@{
    ViewData["Title"] = "Thanh toán";

    decimal amountVnd = ViewBag.Amount is decimal
        ? (decimal)ViewBag.Amount
        : Convert.ToDecimal(ViewBag.Amount);

    long orderId = ViewBag.OrderId is long
        ? (long)ViewBag.OrderId
        : Convert.ToInt64(ViewBag.OrderId);

    var displayAmount = string.Format(new CultureInfo("vi-VN"), "{0:N0}", amountVnd);
    var rawAmount = amountVnd.ToString("0", CultureInfo.InvariantCulture);
}

<h2>Thanh toán đơn hàng</h2>
<p>Số tiền: <b>@displayAmount ₫</b></p>

<div id="payment-element"></div>

<div class="mt-3 d-flex gap-2">
    <button id="pay-btn" class="btn btn-primary">
        <i class="bi bi-credit-card"></i> Thanh toán
    </button>

    <!-- ⭐ Nút quay lại trang Checkout -->
    

</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("@ViewBag.StripePk");
    const orderId = @orderId;
    const vndAmount = "@rawAmount";

    let elements;

    async function init() {
        const resp = await fetch("/payment/create-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ vndAmount })
        });

        if (!resp.ok) {
            let err = null;
            try { err = await resp.json(); } catch { }
            alert("Không tạo được phiên thanh toán: " + (err?.error ?? resp.statusText));
            return;
        }

        const { clientSecret } = await resp.json();

        elements = stripe.elements({ clientSecret });

        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");
    }

    init();

    document.getElementById("pay-btn").addEventListener("click", async () => {
        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: window.location.origin + "/payment/success?orderId=" + orderId
            }
        });

        if (error) {
            alert(error.message);
        }
    });
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
